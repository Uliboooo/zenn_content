---
title: "Rustã§ç°¡å˜ã«structã‚’ä¿å­˜ã™ã‚‹traitã‚’ä½œã‚‹"
emoji: â€œğŸ’¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [rust, æ°¸ç¶šåŒ–]
published: true
---

## æ¦‚è¦

- structã‚’serdeã‚’ç”¨ã„ã¦jsonã‚„tomlã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹
- ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’fsãªã©ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹
- ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ã‚·ã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã€èª­ã¿å‡ºã™

## Code

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯tomlç”¨ã€‚`<P: AsRef<Path>>`ã¯traitå…¨ä½“ã§ã¾ã¨ã‚ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã€‚

```toml: Cargo.toml
[dependencies]
serde = {version = "1.0.219", features = ["derive"]}
toml = "0.9.5"
```

```rust:storable.rs
// serdeã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã¨ãƒ‡ã‚·ã‚¢ãƒ©ã‚¤ã‚ºã®ãŸã‚
use serde::{Serialize, de::DeserializeOwned};
// ioé–¢é€£
use std::{
    fs::{self, OpenOptions},
    io::{self, Write},
    path::Path,
};
// tomlã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãŸã‚
use toml::{from_str, to_string_pretty};

#[derive(Debug)]
pub enum Error {
    IoE(io::Error),
    ParTomlE(toml::ser::Error),
    DesTomlE(toml::de::Error),
}

pub trait Storable {
    /// pathã¯ä¿å­˜å…ˆ
    /// new_createã¯æ–°è¦ä½œæˆã‚’è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹ã€‚OpenOptionsã®.create()ã«ãã®ã¾ã¾æ¸¡ã•ã‚Œã‚‹
    fn save<P: AsRef<Path>>(&self, path: P, new_create: bool) -> Result<(), Error>
    where
        // Selfã¯`Serialize`ã¨`Deserialize`ã‚’deriveãªã©ã§ä»˜ä¸ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹
        Self: Serialize + DeserializeOwned,
    {
        let s = to_string_pretty(self).map_err(Error::ParTomlE)?;
        let mut f = OpenOptions::new()
            .write(true)
            .truncate(true)
            .create(new_create)
            .open(path)
            .map_err(Error::IoE)?;
        f.write_all(s.as_bytes()).map_err(Error::IoE)
    }
    // æˆ»ã‚Šå€¤ã¯Self
    fn load<P: AsRef<Path>>(path: P) -> Result<Self, Error>
    where
        Self: Serialize + DeserializeOwned,
    {
        let file_content = fs::read_to_string(path).map_err(Error::IoE)?;
        from_str::<Self>(&file_content).map_err(Error::DesTomlE)
    }
}
```

## Example

```rust: ex.rust
#[derive(Debug, Serialize, Deserialize)]
struct Person {
    name: String,
    age: u32,
    os: Os,
}

impl Storable for Person {}

#[derive(Debug, Serialize, Deserialize)]
enum Os {
    Mac,
    Linux,
    Windows,
}

fn main() {
    let mike = Person {
        name: "Mike".to_string(),
        age: 20,
        os: Os::Linux,
    };
    mike.save("./users/mike.toml", true).unwrap();

    let loaded_mike = Person::load("./users/mike.toml").unwrap();

    println!("{loaded_mike:?}");
}
```

Exampleã®ã‚³ãƒ¼ãƒ‰ã¯unwrapã—ã¾ãã‚Šãªã®ã§æ³¨æ„ã€‚jsonã®å ´åˆã¯`serde_json`ã‚’ä½¿ã†ã¨ã»ã¼åŒã˜æ‰‹é †ã§è¡Œã‘ã‚‹ã€‚
